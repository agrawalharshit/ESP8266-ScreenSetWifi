<!-- Developed by: Eduardo Zola (http://www.zolalab.com.br) @brazil/sp -->
<!DOCTYPE html>
<html lang="en">
<head>
  <title>ESP8266 LIGHT PULSE INPUT CREDENTIALS</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>


   <style>
   .center {float: none;margin-left: auto;margin-right: auto;}
   .btn-space {margin-right: 5px;}
   .input-small{float:left}
   </style>

</head>
<body>
<div class="container">
  <h4>Welcome to the Esp8266 Light Pulse Input Credentials</h4>
  <div class="panel-group">

      <div class="panel panel-primary"  id="panel0">
      <div class="panel-heading">Step 1: Set your mobile screen to 80% of brightness</div>
      <div class="panel-body">
               Put some instructions here...
			   <BR><BR>
			   <button type="button" id="but0" class="btn btn-primary pull-right">Next</button>
      </div>
    </div>

  
    <div class="panel panel-primary"  id="panel1">
      <div class="panel-heading">Step 2: Please, fill the fields with your network informations.</div>
      <div class="panel-body">
               <div class="form-group">
                 <label for="ssid">WiFi Network name (SSID):</label>
                 <input type="text" class="form-control" id="ssid" maxlength=60 value="My SSID">
               </div>
               <div class="form-group">
                 <label for="pwd">Senha do WiFi:</label>
                 <input type="password" class="form-control" id="pwd" maxlength=60 value="1234">
               </div>

			   <BR><BR>
			   <button type="button" id="but1" class="btn btn-primary pull-right">Next</button>
      </div>
    </div>

	
    <div class="panel panel-primary" id="panel2">
      <div class="panel-heading">Step 3: Place your device over the black square, and then click on transfer button</div>
      <div class="panel-body">

 		 <center><progress value="0" id="pbar1" style="width:280px;margin-bottom:3px"></center>
         <div class="panel panel-default center" style="width:280px;height:280px;">
            <div id="box" style="width:250px;height:250px;margin:15px;background-color:black">
            </div>
         </div>
 		 <center><progress value="0" id="pbar2" style="width:280px;margin-top:7px"></center>

         <BR>

         <button type="button" id="but4" class="btn btn-primary pull-left">Back</button>
         <button type="button" id="but5" class="btn btn-primary pull-right">Transfer</button> 
      </div>
  
	  </div>


  </div>
</div>

</body>
</html>

<script>

$(document).ready(function(){
  $('#panel1').hide();
  $('#panel2').hide();
});

$("#but0").click(function(){
    $("#panel0").slideUp(500, function() {$("#panel1").slideDown();} );
});


$("#but1").click(function(){

    var ssid = document.getElementById("ssid").value;
    var pwd = document.getElementById("pwd").value;

    ssid = ssid.trim();
    pwd = pwd.trim();
	
    if(ssid == "" || pwd == "") return;

   
    $("#panel1").slideUp(500, function() {$("#panel2").slideDown();} );
});

$("#but2").click(function(){
    $("#panel2").slideUp(500, function() {$("#panel1").slideDown();} );
});



$("#but4").click(function(){
   window.transf = false;
   document.getElementById("pbar1").value = 0;
   document.getElementById("pbar2").value = 0;
   $("#panel2").slideUp(500, function() {$("#panel1").slideDown();} );
});


$("#but5").click(function(){
   init(); 
});



var inp = document.querySelector('#pwd');

inp.addEventListener( 'focus', function(){
    inp.type = 'text';
});
inp.addEventListener( 'blur', function(){
    inp.type = 'password';
});

var TXT = "";
var XBIN = "";


var box;
var TEXTO;


var cnt = 0;
var sz = 0;
var lastBit;
var thisBit;


window.rtimeOut=function(callback,delay){
 var dateNow=Date.now,
     requestAnimation=window.requestAnimationFrame,
     start=dateNow(),
     stop,
     timeoutFunc=function(){
      dateNow()-start<delay?stop||requestAnimation(timeoutFunc):callback()
     };
 requestAnimation(timeoutFunc);
 return{
  clear:function(){stop=1}
 }
}



function init()
{
   box = document.getElementById("box");
   
   var ssid = document.getElementById("ssid").value;
   var pwd = document.getElementById("pwd").value;

   ssid = ssid.trim();
   pwd = pwd.trim();

   
   if(ssid == "" || pwd == "") return;
   
   var pbar1 = document.getElementById("pbar1");
   var pbar2 = document.getElementById("pbar2");

   var PULSES = 0;
   
   
   TXT = ""
   TXT = TXT + ">"+ssid+ String.fromCharCode(10);
   TXT = TXT + pwd + String.fromCharCode(10);
   TXT = TXT + String.fromCharCode(crc(TXT));

   XBIN = binary(TXT) + "0";
   cnt = 0;
   sz = XBIN.length;
   
   pbar1.max = sz;
   pbar1.value = 0;

   pbar2.max = sz;
   pbar2.value = 0;
   
   window.transf = true;
   
   lastBit = 0;
   send();
}


function send()
{
    if(!window.transf || cnt > sz) {box.style.backgroundColor="#000000";return;};

    thisBit = XBIN[cnt];
	cnt++;
    pbar1.value = cnt;
    pbar2.value = cnt;
	
    if(thisBit != lastBit) 
	{
        if(thisBit == "1") box.style.backgroundColor="#FFFFFF"; else box.style.backgroundColor="#000000";
        lastBit = thisBit;
//        setTimeout("send()",34);
        rtimeOut(send,34);
	}
	else 
	{
        if(thisBit == "1") box.style.backgroundColor="#000000"; else box.style.backgroundColor="#FFFFFF";
        lastBit = thisBit;
//        setTimeout("goColor();",200);
        rtimeOut(goColor,204);
	}

}

function goColor()
{
   if(thisBit == "1") box.style.backgroundColor="#FFFFFF"; else box.style.backgroundColor="#000000";
//   setTimeout("send()",34);
   rtimeOut(send,34);
}




function binary(input) 
{
    output = "";
    for (i=0; i < input.length; i++) 
    {
        bin = input[i].charCodeAt(0).toString(2);
        ln = 8-bin.length;
        zeros = "";
        for(j=0;j<ln;j++) zeros = zeros + "0";
        bin = zeros + bin;
        output += bin;
    }
    return(output);
}


function dec2binary(dec)
{
    bin = (dec >>> 0).toString(2);
    ln = 8-bin.length;
    zeros = "";
    for(j=0;j<ln;j++) zeros = zeros + "0";
    bin = zeros + bin;
    return(bin);
}

function crc(str) 
{
    var xcrc = 0;
    var qtd = str.length;

    v1 = str.charCodeAt(0);
    for(var i = 1;i<qtd;i++) 
    {
        v2 = str.charCodeAt(i);
        if(v2 > v1) xcrc += (v2-v1); else xcrc += (v1-v2);
        if(xcrc > 255) xcrc -= 255;
        v1 = v2;
    }

    return(xcrc);

};


</script>
